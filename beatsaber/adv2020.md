はじめまして。eiryplusと申します。
この記事は、 [Beat Saber Advent Calendar 2020](https://adventar.org/calendars/5496) 23日目の記事となります。


# 譜面を解析してみる

Beat Saberの譜面の難易度については、 **NPS**  (norts per Second、ノーツ数を曲の長さで割った値）と、レベル（AIが自動的に算出した難易度）の2つが標準で利用されていると思います。
しかし、実際は脳トレ譜面が得意だったり、ストリームが得意だったりと、人によって得手不得手があります。（なお、私はストリームが大の苦手です）

解析の目的は、難易度とは別に、事前に譜面の傾向を把握したり、ブラインドノーツのような暗記しなければ対応できない配置が無いかを素早く把握する事となります。

なお、この記事で説明している内容は、複数の譜面データを比較して推測した情報で、仕様として明記されている情報ではありません。
間違いなどありましたら、Twitter： @eiryplus までご連絡をお願いします。

## 譜面の構成

譜面は、凡そ以下のファイルで構成されています。

| 役割 | ファイル名 | データ形式 |
| --- | --- | --- |
| 作成者や曲、難易度など譜面全体の情報 | info.dat | JSON |
| 曲データ | song.egg | Ogg Vorbis |
| カバー画像 | Cover.jpg | jpeg |
| 難易度別のマップデータ。<br>{難易度}の部分はEasy、Normal、Hard、Export、ExpertPlus | {難易度}.dat | JSON |

曲データやカバー画像などのファイル名は、一般的に利用されている名前です。実際は info.dat に定義されているので、別名でも問題ないと思います。

## 解析で利用するデータについて

各ファイルから、利用するデータの取得方法を記載していきます。

### info.dat

オリジナルのデータから一部書き換えていますが、以下のようなデータ構造になります。

最重要のデータは **_beatsPerMinute** というキーで格納されています。後ほど出てくるノーツの解析で利用します。

```json
{
  "_version": "2.0.0",
  "_songName": "曲名",
  "_songSubName": "",
  "_songAuthorName": "アーティスト名",
  "_levelAuthorName": "マッパーさん",
  "_beatsPerMinute": 154,
  "_songTimeOffset": 0,
  "_shuffle": 0,
  "_shufflePeriod": 0.5,
  "_previewStartTime": 12,
  "_previewDuration": 10,
  "_songFilename": "song.egg",
  "_coverImageFilename": "cover.jpg",
  "_environmentName": "BigMirrorEnvironment",
  "_customData": {
    "_contributors": [],
    "_customEnvironment": "",
    "_customEnvironmentHash": ""
  },
  "_difficultyBeatmapSets": [
    {
      "_beatmapCharacteristicName": "Standard",
      "_difficultyBeatmaps": [
        {
          "_difficulty": "Hard",
          "_difficultyRank": 5,
          "_beatmapFilename": "Hard.dat",
          "_noteJumpMovementSpeed": 10,
          "_noteJumpStartBeatOffset": 0,
          "_customData": {
            "_difficultyLabel": "",
            "_editorOffset": -33,
            "_editorOldOffset": -33,
            "_warnings": [],
            "_information": [],
            "_suggestions": [],
            "_requirements": []
          }
        },
        {
          "_difficulty": "Expert",
          "_difficultyRank": 7,
          "_beatmapFilename": "Expert.dat",
          "_noteJumpMovementSpeed": 10,
          "_noteJumpStartBeatOffset": 0,
          "_customData": {
            "_difficultyLabel": "",
            "_editorOffset": -33,
            "_editorOldOffset": -33,
            "_warnings": [],
            "_information": [],
            "_suggestions": [],
            "_requirements": []
          }
        }
      ]
    }
  ]
}
```

Pythonでこのデータを取得する場合のサンプルコードです。シンプルなJSONなので、標準のライブラリだけで取得できます。

```python
import json

with open("info.dat", "r", encoding="utf-8") as fp:
    info_dat = json.load(fp)
bpm = info_dat["_beatsPerMinute"]
```

### 曲データ

info.dat や 譜面データの中に、曲の長さに関する情報が格納されていません。 NPSや解析データグラフに表示する場合など、
曲の長さが必要なときは、曲データから直接取得します。

Pythonでこのデータを取得する場合、（多分）標準のライブラリでは不可能なので、 **PyGame** というゲーム開発用のライブラリを利用しています。

```python
import pygame

pygame.mixer.init()  # PyGameの初期化
song = pygame.mixer.Sound("song.egg")
song_length = song.get_length()
```

### 難易度別のマップデータ

```json
{
  "_version": "2.0.0",
  "_BPMChanges": [],
  "_events": [],
  "_notes": [
    {
      "_time": 11.915300369262695,
      "_lineIndex": 0,
      "_lineLayer": 0,
      "_type": 0,
      "_cutDirection": 6
    },
    {
      "_time": 12.915300369262695,
      "_lineIndex": 1,
      "_lineLayer": 0,
      "_type": 1,
      "_cutDirection": 6
    }
  ],
  "_obstacles": [
    {
      "_time": 195.91529846191406,
      "_lineIndex": 0,
      "_type": 0,
      "_duration": 39,
      "_width": 1
    },
    {
      "_time": 195.91529846191406,
      "_lineIndex": 3,
      "_type": 0,
      "_duration": 39,
      "_width": 1
    }
  ],
  "_bookmarks": []
}
```

**_notes** がノーツの情報、　**_obstacles** が障害物の情報になります。
障害物については今回説明を省略させていただきますが、こんな壁が表示されます。
![障害物](obstacles.png)

**_notes** 

#### __time
ノーツを切るタイミング。BPSになっているので、以下の計算で秒に変換します。
```
_time × 60 ÷ bpm（info.datから取得したあれ）
```

#### __lineIndex
左右の位置。0～3で設定されており、0が一番左、3が一番右になります。

#### _lineLayer
上下の位置。0～2で設定されており、0が一番下、2が一番上になります。

#### _type
どちらの手で切るか。0が左手、1が右手になります。

#### __cutDirection
ノーツの向きです。

| 値 | 向き |
| --- | --- |
| 0 | ![上](up.png) |
| 1 | ![下](down.png) |
| 2 | ![上](left.png) |
| 3 | ![上](right.png) |
| 4 | ![上](upper-left.png) |
| 5 | ![上](upper-right.png) |
| 6 | ![上](lower-left.png) |
| 7 | ![上](lower-right.png) |
| 8 | ![上](dot.png) |
